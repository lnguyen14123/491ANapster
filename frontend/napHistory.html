<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Napster | Nap Time History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      type="image/png"
      href="./dist/assets/img/napster_favicon.png"
    />

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
      crossorigin="anonymous"
    />
    <!-- OverlayScrollbars -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlaysscrollbars.min.css"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      crossorigin="anonymous"
    />
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="./dist/css/adminlte.css" />

    <style>
      /* Match nappingPage light purple theme */
      :root {
        --violet: #8b5cf6;
        --violet-600: #7c3aed;
        --violet-400: #a78bfa;
        --violet-300: #c4b5fd;
        --violet-100: #ede9fe;

        --ink: #0f172a;
        --muted: #6b7280;
        --glass: rgba(255, 255, 255, 0.6);
        --ring-bg: #ffffff;

        --line: #e5e7eb;
      }

      /* Background like nappingPage */
      .app-main {
        background: radial-gradient(
            1200px 600px at 10% -10%,
            rgba(139, 92, 246, 0.15),
            transparent 60%
          ),
          radial-gradient(
            800px 500px at 110% 20%,
            rgba(196, 181, 253, 0.22),
            transparent 60%
          ),
          linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
        min-height: 100vh;
      }

      .ambient {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .blob {
        position: absolute;
        border-radius: 9999px;
        filter: blur(40px);
        opacity: 0.4;
        animation: float 18s ease-in-out infinite;
      }
      .blob.violet {
        width: 360px;
        height: 360px;
        background: #c4b5fd;
        left: 10%;
        top: 20%;
      }
      .blob.sky {
        width: 420px;
        height: 420px;
        background: #ede9fe;
        right: 8%;
        bottom: 10%;
        animation-delay: -6s;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0) translateX(0);
        }
        50% {
          transform: translateY(-20px) translateX(10px);
        }
      }

      /* Content shell to sit nicely on gradient */
      .history-shell {
        position: relative;
        z-index: 2;
        padding: 1.5rem 0 2.5rem;
      }

      /* Branding header in card */
      .brand-heading {
        color: var(--ink);
        letter-spacing: 0.08em;
        font-weight: 800;
        font-size: 1.1rem;
      }
      .tagline {
        color: var(--violet-600);
        font-weight: 700;
        font-size: 0.8rem;
      }

      /* Table colors using violet-friendly blues */
      .table thead th {
        background: #e0ecff;
        color: var(--ink);
        border-bottom: 1px solid var(--line);
      }
      .table tbody tr:nth-child(even) td {
        background: #f3f7ff;
      }
      .table tbody tr:hover td {
        background: #e5f3ff;
      }

      /* Cards slightly glassy to match theme */
      .card {
        border-radius: 20px;
        border: 1px solid rgba(15, 23, 42, 0.06);
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(6px);
      }

      .card-header {
        border-radius: 20px 20px 0 0;
      }

      .card-header.bg-lite {
        background: #eef2ff;
        border-bottom: 1px solid rgba(15, 23, 42, 0.06);
      }

      /* Metrics + insights styling */
      .metric {
        border: 1px solid rgba(15, 23, 42, 0.06);
        border-radius: 0.9rem;
        background: #ffffff;
        padding: 0.875rem 1rem;
      }
      .metric .label {
        font-size: 0.8rem;
        color: #6c7280;
      }
      .metric .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--ink);
      }
      .metric .sub {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      #summaryLine {
        font-size: 0.9rem;
        color: var(--muted);
      }
    </style>
  </head>

  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
      <!-- HEADER (aligned with nappingPage structure) -->
      <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a
                class="nav-link"
                data-lte-toggle="sidebar"
                href="#"
                role="button"
              >
                <i class="bi bi-list"></i>
              </a>
            </li>
            <li class="nav-item d-none d-md-block">
              <a href="./nappingPage.html" class="nav-link">Home</a>
            </li>
          </ul>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                <i
                  data-lte-icon="minimize"
                  class="bi bi-fullscreen-exit"
                  style="display: none"
                ></i>
              </a>
            </li>
            <li class="nav-item dropdown user-menu">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                <img
                  src="/dist/assets/img/user2-160x160.jpg"
                  class="user-image rounded-circle shadow"
                  alt="User Image"
                />
                <span class="username-display d-none d-md-inline"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <li class="user-header text-bg-primary">
                  <img
                    src="/dist/assets/img/user2-160x160.jpg"
                    class="rounded-circle shadow"
                    alt="User Image"
                  />
                  <p class="username-display"></p>
                  <small>Member since Nov. 2023</small>
                </li>
                <li class="user-footer">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                  <a
                    id="logout-btn"
                    href="#"
                    class="btn btn-default btn-flat float-end"
                  >
                    Sign out
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>

      <!-- SIDEBAR  -->
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <div class="sidebar-brand">
          <a href="./nappingPage.html" class="brand-link">
            <img
              src="/dist/assets/img/napsterlogo_image.png"
              alt="Napster Logo"
              class="brand-image opacity-75 shadow"
            />
            <span class="brand-text fw-light">Napster</span>
          </a>
        </div>

        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <ul
              class="nav sidebar-menu flex-column"
              data-lte-toggle="treeview"
              role="menu"
              data-accordion="false"
            >
              <li class="nav-item">
                <a href="./nappingPage.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Home</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./dashboard.html" class="nav-link">
                  <i class="nav-icon bi bi-speedometer"></i>
                  <p>Dashboard</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./napHistory.html" class="nav-link active">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Nap History</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./autoNapScheduler.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>AI Nap Scheduler</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./napSchedule.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Nap Schedule</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./userSchedule.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>User Schedule</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./rewards.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Rewards</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./location.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Location Recommendation</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./friends.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Friends System</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./settings.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Settings</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="app-main">
        <!-- Ambient blobs -->
        <div class="ambient" aria-hidden="true">
          <div class="blob violet"></div>
          <div class="blob sky"></div>
        </div>

        <div class="history-shell">
          <!-- Header -->
          <div class="app-content-header">
            <div class="container-fluid">
              <div class="row">
                <div class="col-sm-6">
                  <h3 class="mb-0">Nap Time History</h3>
                </div>
              </div>
            </div>
          </div>

          <div class="app-content">
            <div class="container-fluid">
              <!-- History table -->
              <div class="card mb-3">
                <div class="card-header">
                  <div
                    class="d-flex align-items-center justify-content-between"
                  >
                    <div>
                      <h4 class="mb-0 brand-heading">NAPSTER</h4>
                      <small class="tagline">DREAM MORE, DO MORE</small>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Start Time</th>
                          <th>End Time</th>
                          <th>Duration</th>
                          <th>Notes</th>
                        </tr>
                      </thead>
                      <tbody id="napBody">
                        <!-- Populated via loadNapData() -->
                      </tbody>
                    </table>
                  </div>
                  <p class="mt-2" id="summaryLine" aria-live="polite"></p>
                </div>
              </div>

              <!-- Insights: Metrics + Charts -->
              <div class="card">
                <div class="card-header bg-lite">
                  <h5 class="mb-0">Insights</h5>
                </div>
                <div class="card-body">
                  <!-- Metrics -->
                  <div class="row g-3 mb-3">
                    <div class="col-6 col-md-3">
                      <div class="metric">
                        <div class="label">Total naps</div>
                        <div class="value" id="mTotalNaps">–</div>
                        <div class="sub">rows shown</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="metric">
                        <div class="label">Total time</div>
                        <div class="value" id="mTotalTime">–</div>
                        <div class="sub" id="mTotalMinsSub">minutes</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="metric">
                        <div class="label">Average duration</div>
                        <div class="value" id="mAvg">–</div>
                        <div class="sub">per nap</div>
                      </div>
                    </div>
                    <div class="col-6 col-md-3">
                      <div class="metric">
                        <div class="label">Longest nap</div>
                        <div class="value" id="mLongest">–</div>
                        <div class="sub" id="mLongestDate">–</div>
                      </div>
                    </div>
                  </div>

                  <!-- Charts -->
                  <div class="row g-4">
                    <div class="col-lg-8">
                      <div class="card shadow-sm">
                        <div class="card-body">
                          <h6 class="mb-3">Daily total (minutes)</h6>
                          <canvas
                            id="durationsLine"
                            height="120"
                            aria-label="Line chart of minutes per day"
                            role="img"
                          ></canvas>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <div class="card shadow-sm mb-4">
                        <div class="card-body">
                          <h6 class="mb-3">By weekday</h6>
                          <canvas
                            id="weekdayBar"
                            height="180"
                            aria-label="Bar chart of minutes by weekday"
                            role="img"
                          ></canvas>
                        </div>
                      </div>
                      <div class="card shadow-sm">
                        <div class="card-body">
                          <h6 class="mb-3">Time of day</h6>
                          <canvas
                            id="todDonut"
                            height="180"
                            aria-label="Donut chart of naps by time-of-day"
                            role="img"
                          ></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- FOOTER (match nappingPage style) -->
      <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">Dream More. Do More.</div>
        <strong>Copyright &copy; 2025&nbsp;</strong> All rights reserved.
      </footer>
    </div>

    <!-- Scripts -->
    <script
      src="https://cdn.jsdelivr.net/npm/overlaysscrollbars@2.10.1/browser/overlaysscrollbars.browser.es6.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <!-- Chart.js for charts -->
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="../../dist/js/adminlte.js"></script>

    <script>
      // Sidebar scrollbars init (same pattern as home)
      const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
      const Default = {
        scrollbarTheme: "os-theme-light",
        scrollbarAutoHide: "leave",
        scrollbarClickScroll: true,
      };
      document.addEventListener("DOMContentLoaded", function () {
        const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
        if (
          sidebarWrapper &&
          typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined"
        ) {
          OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: Default.scrollbarTheme,
              autoHide: Default.scrollbarAutoHide,
              clickScroll: Default.scrollbarClickScroll,
            },
          });
        }
      });
    </script>

    <!-- Duration + analytics helpers -->
    <script>
      // Duration helpers
      const toDate = (el) =>
        el?.tagName === "TIME" && el.dateTime
          ? new Date(el.dateTime)
          : new Date(el?.textContent?.trim() ?? "");
      const minutesBetween = (a, b) => Math.max(0, Math.round((b - a) / 60000));
      const formatDuration = (m) =>
        m < 60
          ? `${m} mins`
          : `${Math.floor(m / 60)}h ${m % 60 ? (m % 60) + "m" : ""}`.trim();

      function recalc() {
        const rows = Array.from(document.querySelectorAll("#napBody tr"));
        let total = 0;
        rows.forEach((tr) => {
          const start = toDate(tr.cells[1].querySelector("time"));
          const end = toDate(tr.cells[2].querySelector("time"));
          const mins =
            !isNaN(start) && !isNaN(end) ? minutesBetween(start, end) : 0;
          tr.cells[3].textContent = formatDuration(mins);
          tr.cells[3].dataset.minutes = String(mins);
          total += mins;
        });
        document.getElementById(
          "summaryLine"
        ).textContent = `Total napping time shown: ${formatDuration(
          total
        )} (${total} minutes)`;
      }

      // ---------- Analytics from existing table ----------
      const WDAY = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const fmtYMD = (d) =>
        [
          d.getFullYear(),
          String(d.getMonth() + 1).padStart(2, "0"),
          String(d.getDate()).padStart(2, "0"),
        ].join("-");

      function parseRows() {
        const rows = Array.from(document.querySelectorAll("#napBody tr"));
        const items = [];
        rows.forEach((tr) => {
          const dateEl = tr.cells[0].querySelector("time");
          const startEl = tr.cells[1].querySelector("time");
          const endEl = tr.cells[2].querySelector("time");
          const minsAttr = parseInt(tr.cells[3].dataset.minutes || "0", 10);

          const date = dateEl?.dateTime ? new Date(dateEl.dateTime) : null;
          const start = startEl?.dateTime ? new Date(startEl.dateTime) : null;
          const end = endEl?.dateTime ? new Date(endEl.dateTime) : null;

          const mins =
            !isNaN(minsAttr) && minsAttr > 0
              ? minsAttr
              : !isNaN(start) && !isNaN(end)
              ? Math.max(0, Math.round((end - start) / 60000))
              : 0;

          if (date && mins > 0) {
            items.push({
              date,
              ymd: fmtYMD(date),
              weekday: date.getDay(),
              mins,
              startHour: start
                ? start.getHours() + start.getMinutes() / 60
                : null,
            });
          }
        });
        return items;
      }

      function summarize(items) {
        const totalNaps = items.length;
        const totalMins = items.reduce((s, x) => s + x.mins, 0);
        const avg = totalNaps ? Math.round(totalMins / totalNaps) : 0;

        let longest = { mins: 0, date: null };
        items.forEach((x) => {
          if (x.mins > longest.mins) longest = { mins: x.mins, date: x.date };
        });

        const byDay = new Map();
        items.forEach((x) =>
          byDay.set(x.ymd, (byDay.get(x.ymd) || 0) + x.mins)
        );

        const weekday = Array.from({ length: 7 }, () => 0);
        items.forEach((x) => {
          weekday[x.weekday] += x.mins;
        });

        const buckets = { Night: 0, Morning: 0, Afternoon: 0, Evening: 0 };
        items.forEach((x) => {
          const h = x.startHour;
          if (h === null) return;
          if (h >= 21 || h < 5) buckets.Night += 1;
          else if (h >= 5 && h < 12) buckets.Morning += 1;
          else if (h >= 12 && h < 17) buckets.Afternoon += 1;
          else buckets.Evening += 1;
        });

        const dailySeries = Array.from(byDay.entries())
          .map(([ymd, mins]) => ({ ymd, mins, t: new Date(ymd) }))
          .sort((a, b) => a.t - b.t);

        return {
          totalNaps,
          totalMins,
          avg,
          longest,
          weekday,
          buckets,
          dailySeries,
        };
      }

      function fmtDur(m) {
        if (!m) return "0 mins";
        return m < 60
          ? `${m} mins`
          : `${Math.floor(m / 60)}h ${m % 60 ? (m % 60) + "m" : ""}`;
      }

      let lineChart, barChart, donutChart;

      function renderMetrics(s) {
        document.getElementById("mTotalNaps").textContent = String(s.totalNaps);
        document.getElementById("mTotalTime").textContent = fmtDur(s.totalMins);
        document.getElementById(
          "mTotalMinsSub"
        ).textContent = `${s.totalMins} minutes`;
        document.getElementById("mAvg").textContent = fmtDur(s.avg);
        document.getElementById("mLongest").textContent = fmtDur(
          s.longest.mins
        );
        document.getElementById("mLongestDate").textContent = s.longest.date
          ? s.longest.date.toLocaleDateString()
          : "–";
      }

      function renderCharts(s) {
        [lineChart, barChart, donutChart].forEach((c) => {
          try {
            c?.destroy();
          } catch (_) {}
        });

        const ctxLine = document.getElementById("durationsLine");
        if (ctxLine) {
          lineChart = new Chart(ctxLine, {
            type: "line",
            data: {
              labels: s.dailySeries.map((d) =>
                new Date(d.ymd).toLocaleDateString()
              ),
              datasets: [
                {
                  label: "Minutes",
                  data: s.dailySeries.map((d) => d.mins),
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 15 } },
              },
            },
          });
        }

        const ctxBar = document.getElementById("weekdayBar");
        if (ctxBar) {
          barChart = new Chart(ctxBar, {
            type: "bar",
            data: {
              labels: WDAY,
              datasets: [{ label: "Minutes", data: s.weekday }],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, ticks: { stepSize: 15 } },
              },
            },
          });
        }

        const ctxDonut = document.getElementById("todDonut");
        if (ctxDonut) {
          const labels = Object.keys(s.buckets);
          const values = labels.map((k) => s.buckets[k]);
          donutChart = new Chart(ctxDonut, {
            type: "doughnut",
            data: { labels, datasets: [{ data: values }] },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "bottom" },
                tooltip: {
                  callbacks: {
                    label: (c) => `${c.label}: ${c.raw}`,
                  },
                },
              },
              cutout: "60%",
            },
          });
        }
      }

      function renderAnalytics() {
        const items = parseRows();
        const summary = summarize(items);
        renderMetrics(summary);
        renderCharts(summary);
      }
    </script>

    <!-- Auth + logout (single copy) -->
    <script>
      fetch("/api/user")
        .then((res) => {
          if (res.status === 401) {
            window.location.href = "/signin";
            return null;
          }
          return res.json();
        })
        .then((data) => {
          if (data && data.username) {
            document.querySelectorAll(".username-display").forEach((el) => {
              el.innerText = data.username;
            });
          }
        })
        .catch((err) => console.error("Fetch error:", err));

      document.getElementById("logout-btn")?.addEventListener("click", () => {
        fetch("/logout", { method: "POST" })
          .then(() => {
            window.location.href = "/signin";
          })
          .catch((err) => console.error("Logout error:", err));
      });
    </script>

    <!-- Load nap data from backend and hook analytics -->
    <script>
      function calculateDuration(start, end) {
        if (!end) return "—";
        const diffMs = new Date(end) - new Date(start);
        const minutes = Math.round(diffMs / 60000);
        const seconds = Math.round((diffMs % 60000) / 1000);
        return `${minutes > 0 ? minutes + " min " : ""}${seconds} sec`;
      }

      const formatterDate = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      const formatterTime = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });

      let naps = [];

      async function loadNapData() {
        try {
          const res = await fetch("/api/naphistory");
          if (!res.ok) throw new Error("Failed to load naps");
          naps = (await res.json()).naps || [];

          const napBody = document.getElementById("napBody");
          napBody.innerHTML = "";

          naps.slice(0, 10).forEach((nap) => {
            const start = new Date(nap.napstart);
            const end = nap.napend ? new Date(nap.napend) : null;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><time datetime="${nap.napstart}">${formatterDate.format(
              start
            )}</time></td>
              <td><time datetime="${nap.napstart}">${formatterTime.format(
              start
            )}</time></td>
              <td><time datetime="${nap.napend || ""}">${
              end ? formatterTime.format(end) : "—"
            }</time></td>
              <td data-duration>${calculateDuration(start, end)}</td>
              <td>${end ? "Completed" : "Ongoing..."}</td>
            `;
            napBody.appendChild(tr);
          });

          recalc();
          renderAnalytics();
        } catch (err) {
          console.error("Error loading nap data:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadNapData();
      });
    </script>
  </body>
</html>
