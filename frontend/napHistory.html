<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Napster | Nap Time History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="./dist/assets/img/napster_favicon.png">

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
      crossorigin="anonymous"
    />
    <!-- OverlayScrollbars -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      crossorigin="anonymous"
    />
    <!-- AdminLTE CSS -->
    <link rel="stylesheet" href="./dist/css/adminlte.css" />

    <style>
      /* Optional page-specific polish to echo your original colors */
      :root {
        --ink:#2c3e50;
        --violet:#cc99ff;
        --blue-50:#f0f8ff;
        --blue-100:#cceeff;
        --blue-200:#f2f9ff;
        --hover:#e0f7fa;
      }
      .brand-heading { color: var(--ink); letter-spacing: .5px; }
      .tagline { color: var(--violet); font-weight: 700; }
      .table thead th { background: var(--blue-100); color: var(--ink); }
      .table tbody tr:nth-child(even) td { background: var(--blue-200); }
      .table tbody tr:hover td { background: var(--hover); }

      /* Metrics + insights styling */
      .metric {
        border: 1px solid rgba(0,0,0,.06);
        border-radius: .75rem;
        background: #fff;
        padding: .875rem 1rem;
      }
      .metric .label { font-size: .8rem; color: #6c757d; }
      .metric .value { font-size: 1.25rem; font-weight: 700; color: var(--ink); }
      .metric .sub { font-size: .75rem; color: #8898aa; }
      .card-header.bg-lite {
        background: var(--blue-50);
        border-bottom: 1px solid rgba(0,0,0,.06);
      }
    </style>
  </head>


  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">

      <!-- HEADER: copied exactly from dashboard.html -->
      <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                <i class="bi bi-list"></i>
              </a>
            </li>
            <li class="nav-item d-none d-md-block"><a href="./nappingPage.html" class="nav-link">Home</a></li>
          </ul>
          <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown">
              <a class="nav-link" data-bs-toggle="dropdown" href="#">
                <i class="bi bi-bell-fill"></i>
                <span class="navbar-badge badge text-bg-warning">15</span>
              </a>
              <div class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <span class="dropdown-item dropdown-header">15 Notifications</span>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                  <i class="bi bi-envelope me-2"></i> 4 new messages
                  <span class="float-end text-secondary fs-7">3 mins</span>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                  <i class="bi bi-people-fill me-2"></i> 8 friend requests
                  <span class="float-end text-secondary fs-7">12 hours</span>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item">
                  <i class="bi bi-file-earmark-fill me-2"></i> 3 new reports
                  <span class="float-end text-secondary fs-7">2 days</span>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item dropdown-footer"> See All Notifications </a>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
              </a>
            </li>
            <li class="nav-item dropdown user-menu">
              <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                <img src="./dist/assets/img/user2-160x160.jpg" class="user-image rounded-circle shadow" alt="User Image" />
                <span class="username-display d-none d-md-inline"></span>
              </a>
              <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                <li class="user-header text-bg-primary">
                  <img src="./dist/assets/img/user2-160x160.jpg" class="rounded-circle shadow" alt="User Image" />
                  <p class="username-display"> </p>
                  <small>Member since Nov. 2023</small>
                </li>
                <li class="user-footer">
                  <a href="#" class="btn btn-default btn-flat">Profile</a>
                  <a id="logout-btn" href="#" class="btn btn-default btn-flat float-end">Sign out</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>

      <!--begin::Sidebar-->
      <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
        <!--begin::Sidebar Brand-->
        <div class="sidebar-brand">
          <!--begin::Brand Link-->
          <a href="./nappingPage.html" class="brand-link">
            <!--begin::Brand Image-->
            <img
              src="/dist/assets/img/napsterlogo_image.png"
              alt="AdminLTE Logo"
              class="brand-image opacity-75 shadow"
            />
            <!--end::Brand Image-->
            <!--begin::Brand Text-->
            <span class="brand-text fw-light">Napster</span>
            <!--end::Brand Text-->
          </a>
          <!--end::Brand Link-->
        </div>
        <!--end::Sidebar Brand-->
        <!--begin::Sidebar Wrapper-->
        <div class="sidebar-wrapper">
          <nav class="mt-2">
            <!--begin::Sidebar Menu-->
            <ul
              class="nav sidebar-menu flex-column"
              data-lte-toggle="treeview"
              role="menu"
              data-accordion="false"
            >

              <li class="nav-item">
                <a href="./nappingPage.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Home</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./dashboard.html" class="nav-link">
                  <i class="nav-icon bi bi-speedometer"></i>
                  <p>
                    Dashboard
                  </p>
                </a>
              </li>
              <li class="nav-item">
                <a href="./napHistory.html" class="nav-link active">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Nap History</p>
                </a>
              </li>

              <li class="nav-item">
                <a href="./napSchedule.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Nap Schedule</p>
                </a>
              </li>

              <li class="nav-item"><a href="./userSchedule.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>User Schedule</p></a></li>


              <li class="nav-item"><a href="./rewards.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>Rewards</p></a></li>

              <li class="nav-item">
                <a href="./settings.html" class="nav-link">
                  <i class="nav-icon bi bi-moon-stars"></i>
                  <p>Settings</p>
                </a>
              </li>



                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="#" class="nav-link">
                      <i class="nav-icon bi bi-box-arrow-in-right"></i>
                      <p>
                        Version 1
                        <i class="nav-arrow bi bi-chevron-right"></i>
                      </p>
                    </a>
                    <ul class="nav nav-treeview">
                      <li class="nav-item">
                        <a href="./examples/login.html" class="nav-link">
                          <i class="nav-icon bi bi-circle"></i>
                          <p>Login</p>
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="./examples/register.html" class="nav-link">
                          <i class="nav-icon bi bi-circle"></i>
                          <p>Register</p>
                        </a>
                      </li>
                    </ul>
                  </li>
                  <li class="nav-item">
                    <a href="#" class="nav-link">
                      <i class="nav-icon bi bi-box-arrow-in-right"></i>
                      <p>
                        Version 2
                        <i class="nav-arrow bi bi-chevron-right"></i>
                      </p>
                    </a>
                    <ul class="nav nav-treeview">
                      <li class="nav-item">
                        <a href="./examples/login-v2.html" class="nav-link">
                          <i class="nav-icon bi bi-circle"></i>
                          <p>Login</p>
                        </a>
                      </li>
                      <li class="nav-item">
                        <a href="./examples/register-v2.html" class="nav-link">
                          <i class="nav-icon bi bi-circle"></i>
                          <p>Register</p>
                        </a>
                      </li>
                    </ul>
                  </li>
                  <li class="nav-item">
                    <a href="./examples/lockscreen.html" class="nav-link">
                      <i class="nav-icon bi bi-circle"></i>
                      <p>Lockscreen</p>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
            <!--end::Sidebar Menu-->
          </nav>
        </div>
        <!--end::Sidebar Wrapper-->
      </aside>
      <!--end::Sidebar-->

      <!-- MAIN CONTENT -->
      <main class="app-main">
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6">
                <h3 class="mb-0">Nap Time History</h3>
              </div>
            </div>
          </div>
        </div>

        <div class="app-content">
          <div class="container-fluid">
            <div class="card">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h4 class="mb-0 brand-heading">NAPSTER</h4>
                    <small class="tagline">DREAM MORE, DO MORE</small>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Duration</th>
                        <th>Notes</th>
                      </tr>
                    </thead>
                    <tbody id="napBody">
                      <!-- <tr>
                        <td><time datetime="2025-04-23">April 23, 2025</time></td>
                        <td><time datetime="2025-04-23T14:00">2:00 PM</time></td>
                        <td><time datetime="2025-04-23T14:45">2:45 PM</time></td>
                        <td data-duration></td>
                        <td>Felt refreshed</td>
                      </tr>
                      <tr>
                        <td><time datetime="2025-04-22">April 22, 2025</time></td>
                        <td><time datetime="2025-04-22T13:30">1:30 PM</time></td>
                        <td><time datetime="2025-04-22T14:15">2:15 PM</time></td>
                        <td data-duration></td>
                        <td>Interrupted</td>
                      </tr>
                      <tr>
                        <td><time datetime="2025-04-21">April 21, 2025</time></td>
                        <td><time datetime="2025-04-21T15:00">3:00 PM</time></td>
                        <td><time datetime="2025-04-21T15:30">3:30 PM</time></td>
                        <td data-duration></td>
                        <td>Quick power nap</td>
                      </tr> -->
                    </tbody>
                  </table>
                </div>
                <p class="text-secondary mt-2" id="summaryLine" aria-live="polite"></p>
              </div>
            </div>

            <!-- Insights: Metrics + Charts -->
            <div class="card mt-3">
              <div class="card-header bg-lite">
                <h5 class="mb-0">Insights</h5>
              </div>
              <div class="card-body">
                <!-- Metrics -->
                <div class="row g-3 mb-3">
                  <div class="col-6 col-md-3">
                    <div class="metric">
                      <div class="label">Total naps</div>
                      <div class="value" id="mTotalNaps">–</div>
                      <div class="sub">rows shown</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="metric">
                      <div class="label">Total time</div>
                      <div class="value" id="mTotalTime">–</div>
                      <div class="sub" id="mTotalMinsSub">minutes</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="metric">
                      <div class="label">Average duration</div>
                      <div class="value" id="mAvg">–</div>
                      <div class="sub">per nap</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="metric">
                      <div class="label">Longest nap</div>
                      <div class="value" id="mLongest">–</div>
                      <div class="sub" id="mLongestDate">–</div>
                    </div>
                  </div>
                </div>

                <!-- Charts -->
                <div class="row g-4">
                  <div class="col-lg-8">
                    <div class="card shadow-sm">
                      <div class="card-body">
                        <h6 class="mb-3">Daily total (minutes)</h6>
                        <canvas id="durationsLine" height="120" aria-label="Line chart of minutes per day" role="img"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-4">
                    <div class="card shadow-sm mb-4">
                      <div class="card-body">
                        <h6 class="mb-3">By weekday</h6>
                        <canvas id="weekdayBar" height="180" aria-label="Bar chart of minutes by weekday" role="img"></canvas>
                      </div>
                    </div>
                    <div class="card shadow-sm">
                      <div class="card-body">
                        <h6 class="mb-3">Time of day</h6>
                        <canvas id="todDonut" height="180" aria-label="Donut chart of naps by time-of-day" role="img"></canvas>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

          </div>
        </div>
      </main>

      <!-- FOOTER: same as dashboard -->
      <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">Dream more. Do More.</div>
        <strong>
          Copyright &copy; 2014-2024
          <a href="https://adminlte.io" class="text-decoration-none">AdminLTE.io</a>.
        </strong>
        All rights reserved.
      </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script src="./dist/js/adminlte.js"></script>

    <script>
      // Sidebar scrollbars init (same as dashboard)
      const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
      const Default = { scrollbarTheme: 'os-theme-light', scrollbarAutoHide: 'leave', scrollbarClickScroll: true };
      document.addEventListener('DOMContentLoaded', function () {
        const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
        if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
          OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: Default.scrollbarTheme,
              autoHide: Default.scrollbarAutoHide,
              clickScroll: Default.scrollbarClickScroll,
            },
          });
        }
      });

      // Duration helpers
      const toDate = (el) => (el?.tagName === 'TIME' && el.dateTime ? new Date(el.dateTime) : new Date(el?.textContent?.trim() ?? ''));
      const minutesBetween = (a,b) => Math.max(0, Math.round((b - a)/60000));
      const formatDuration = (m) => m < 60 ? `${m} mins` : `${Math.floor(m/60)}h ${m%60? (m%60 + 'm'): ''}`.trim();

      function recalc() {
        const rows = Array.from(document.querySelectorAll('#napBody tr'));
        let total = 0;
        rows.forEach(tr => {
          const start = toDate(tr.cells[1].querySelector('time'));
          const end = toDate(tr.cells[2].querySelector('time'));
          const mins = (!isNaN(start) && !isNaN(end)) ? minutesBetween(start, end) : 0;
          tr.cells[3].textContent = formatDuration(mins);
          tr.cells[3].dataset.minutes = String(mins);
          total += mins;
        });
        document.getElementById('summaryLine').textContent = `Total napping time shown: ${formatDuration(total)} (${total} minutes)`;
      }
      recalc();

      // ---------- Analytics from existing table ----------
      const WDAY = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const fmtYMD = d => [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');

      function parseRows() {
        const rows = Array.from(document.querySelectorAll('#napBody tr'));
        const items = [];
        rows.forEach(tr => {
          const dateEl = tr.cells[0].querySelector('time');
          const startEl = tr.cells[1].querySelector('time');
          const endEl = tr.cells[2].querySelector('time');
          const minsAttr = parseInt(tr.cells[3].dataset.minutes || '0', 10);

          const date = dateEl?.dateTime ? new Date(dateEl.dateTime) : null;
          const start = startEl?.dateTime ? new Date(startEl.dateTime) : null;
          const end = endEl?.dateTime ? new Date(endEl.dateTime) : null;

          const mins = (!isNaN(minsAttr) && minsAttr > 0)
            ? minsAttr
            : ((!isNaN(start) && !isNaN(end)) ? Math.max(0, Math.round((end - start)/60000)) : 0);

          if (date && mins > 0) {
            items.push({
              date,
              ymd: fmtYMD(date),
              weekday: date.getDay(),
              mins,
              startHour: start ? (start.getHours() + start.getMinutes()/60) : null
            });
          }
        });
        return items;
      }

      function summarize(items) {
        const totalNaps = items.length;
        const totalMins = items.reduce((s,x) => s + x.mins, 0);
        const avg = totalNaps ? Math.round(totalMins / totalNaps) : 0;

        let longest = { mins: 0, date: null };
        items.forEach(x => { if (x.mins > longest.mins) longest = { mins: x.mins, date: x.date }; });

        const byDay = new Map(); // ymd -> minutes
        items.forEach(x => byDay.set(x.ymd, (byDay.get(x.ymd) || 0) + x.mins));

        const weekday = Array.from({length:7}, () => 0);
        items.forEach(x => { weekday[x.weekday] += x.mins; });

        const buckets = { Night:0, Morning:0, Afternoon:0, Evening:0 };
        items.forEach(x => {
          const h = x.startHour;
          if (h === null) return;
          if (h >= 21 || h < 5) buckets.Night += 1;
          else if (h >= 5 && h < 12) buckets.Morning += 1;
          else if (h >= 12 && h < 17) buckets.Afternoon += 1;
          else buckets.Evening += 1;
        });

        const dailySeries = Array.from(byDay.entries())
          .map(([ymd, mins]) => ({ ymd, mins, t: new Date(ymd) }))
          .sort((a,b) => a.t - b.t);

        return { totalNaps, totalMins, avg, longest, weekday, buckets, dailySeries };
      }

      function fmtDur(m) {
        if (!m) return '0 mins';
        return m < 60 ? `${m} mins` : `${Math.floor(m/60)}h ${m%60 ? (m%60 + 'm') : ''}`;
      }

      let lineChart, barChart, donutChart;

      function renderMetrics(s) {
        document.getElementById('mTotalNaps').textContent = String(s.totalNaps);
        document.getElementById('mTotalTime').textContent = fmtDur(s.totalMins);
        document.getElementById('mTotalMinsSub').textContent = `${s.totalMins} minutes`;
        document.getElementById('mAvg').textContent = fmtDur(s.avg);
        document.getElementById('mLongest').textContent = fmtDur(s.longest.mins);
        document.getElementById('mLongestDate').textContent = s.longest.date ? s.longest.date.toLocaleDateString() : '–';
      }

      function renderCharts(s) {
        [lineChart, barChart, donutChart].forEach(c => { try { c?.destroy(); } catch(_){} });

        // Line: daily totals
        const ctxLine = document.getElementById('durationsLine');
        if (ctxLine) {
          lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
              labels: s.dailySeries.map(d => new Date(d.ymd).toLocaleDateString()),
              datasets: [{ label: 'Minutes', data: s.dailySeries.map(d => d.mins), tension: .3 }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true, ticks: { stepSize: 15 } } }
            }
          });
        }

        // Bar: weekday totals
        const ctxBar = document.getElementById('weekdayBar');
        if (ctxBar) {
          barChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
              labels: WDAY,
              datasets: [{ label: 'Minutes', data: s.weekday }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true, ticks: { stepSize: 15 } } }
            }
          });
        }

        // Donut: time-of-day buckets
        const ctxDonut = document.getElementById('todDonut');
        if (ctxDonut) {
          const labels = Object.keys(s.buckets);
          const values = labels.map(k => s.buckets[k]);
          donutChart = new Chart(ctxDonut, {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values }] },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw}` } }
              },
              cutout: '60%'
            }
          });
        }
      }

      function renderAnalytics() {
        const items = parseRows();
        const summary = summarize(items);
        renderMetrics(summary);
        renderCharts(summary);
      }

      // Initial analytics render
      renderAnalytics();

      // Optional: auto-refresh analytics when table changes (e.g., dynamic edits)
    </script>

    <script>
      fetch("/api/user")
          .then(res => {
        if (res.status === 401) {
          // Not logged in → redirect to signin page
          window.location.href = "/signin";
          return null;
        }
        return res.json();
      })
      .then(data => {
        if (data && data.username) {
          document.querySelectorAll(".username-display").forEach(el => {
            el.innerText = data.username;
          });
        }
      })
      .catch(err => console.error("Fetch error:", err));
    </script>

    <script>
      fetch("/api/user")
          .then(res => {
        if (res.status === 401) {
          // Not logged in → redirect to signin page
          window.location.href = "/signin";
          return null;
        }
        return res.json();
      })
      .then(data => {
        if (data && data.username) {
          document.querySelectorAll(".username-display").forEach(el => {
            el.innerText = data.username;
          });
        }
      })
      .catch(err => console.error("Fetch error:", err));

      document.getElementById("logout-btn").addEventListener("click", () => {
        fetch("/logout", {
          method: "POST"
        })
          .then(() => {
            // After logout, go to signin page
            window.location.href = "/signin";
          })
          .catch(err => console.error("Logout error:", err));
      });

    </script>


    <script>
      function calculateDuration(start, end) {
        if (!end) return "—";
        const diffMs = new Date(end) - new Date(start);
        const minutes = Math.round(diffMs / 60000);
        const seconds = Math.round((diffMs % 60000) / 1000);
        return `${minutes > 0 ? minutes + " min " : ""}${seconds} sec`;
      }

      const formatterDate = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        year: "numeric",
        month: "long",
        day: "numeric"
      });

      const formatterTime = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });


      let naps = []; // global

      async function loadNapData() {
        try {
          const res = await fetch("/api/naphistory"); // or whatever your endpoint is
          if (!res.ok) throw new Error("Failed to load naps");
          naps = (await res.json()).naps;

          // Clear the current table body
          const napBody = document.getElementById("napBody");
          napBody.innerHTML = "";

          // Populate rows dynamically

          naps.slice(0, 10).forEach(nap => {
            const start = new Date(nap.napstart);
            const end = nap.napend ? new Date(nap.napend) : null;

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><time datetime="${nap.napstart}">${formatterDate.format(start)}</time></td>
              <td><time datetime="${nap.napstart}">${formatterTime.format(start)}</time></td>
              <td><time datetime="${nap.napend || ''}">${end ? formatterTime.format(end) : "—"}</time></td>
              <td data-duration>${calculateDuration(start, end)}</td>
              <td>${end ? "Completed" : "Ongoing..."}</td>
            `;
            napBody.appendChild(tr);
          });

          // Recalculate durations and re-render analytics
          recalc();
          renderAnalytics();

        } catch (err) {
          console.error("Error loading nap data:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadNapData();
      });

    </script>

  </body>
</html>
