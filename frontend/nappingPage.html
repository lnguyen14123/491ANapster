<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Napster | Home Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons / AdminLTE -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlaysscrollbars@2.10.1/styles/overlayscrollbars.min.css" />
  <link rel="stylesheet" href="./dist/css/adminlte.css" />
  <link rel="icon" type="image/png" href="./dist/assets/img/napsterlogo.png" />
  
  <style>
    :root{
      /* Light purple theme */
      --violet:#8b5cf6;
      --violet-600:#7c3aed;
      --violet-400:#a78bfa;
      --violet-300:#c4b5fd;
      --violet-100:#ede9fe;

      --ink:#0f172a;
      --muted:#6b7280;
      --glass: rgba(255,255,255,.6);
      --ring-bg:#ffffff;
    }

    /* Gradient canvas + ambient blobs */
    .app-main{
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(139,92,246,.15), transparent 60%),
        radial-gradient(800px 500px at 110% 20%, rgba(196,181,253,.22), transparent 60%),
        linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
      min-height: 100vh;
    }
    .ambient{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .blob{ position:absolute; border-radius:9999px; filter: blur(40px); opacity:.4; animation: float 18s ease-in-out infinite; }
    .blob.violet{ width:360px;height:360px;background:#c4b5fd; left:10%; top:20%; }
    .blob.sky{ width:420px;height:420px;background:#ede9fe; right:8%; bottom:10%; animation-delay:-6s; }
    @keyframes float{ 0%,100%{ transform: translateY(0) translateX(0) } 50%{ transform: translateY(-20px) translateX(10px) } }

    /* Center stage */
    .center-wrap{
      position: relative;
      z-index: 2;
      min-height: calc(100vh - 112px);
      display:flex; align-items:center; justify-content:center;
      padding: 2.5rem 1rem;
    }

    /* Glass card frame */
    .glass{
      width: min(1020px, 95vw);
      display:grid; grid-template-columns: 1.1fr .9fr; gap: 28px;
      background: var(--glass);
      backdrop-filter: blur(10px) saturate(1.1);
      border: 1px solid rgba(139,92,246,.18);
      box-shadow: 0 20px 60px rgba(2,6,23,.08);
      border-radius: 24px;
      padding: 24px;
    }
    @media (max-width: 900px){ .glass{ grid-template-columns: 1fr; } }

    /* Circular timer (violet) */
    .nap-circle{
      aspect-ratio:1/1; width: 420px; max-width: 100%;
      margin-inline: auto;
      border-radius:50%;
      display:grid; place-items:center; position:relative;
      background:
        radial-gradient(closest-side, var(--ring-bg) 69%, transparent 70% 71%, #f2ecff 0),
        conic-gradient(var(--progress, 0%), var(--violet), var(--violet-400) 40%, var(--violet-300) 70%, var(--violet-100));
      box-shadow: 0 16px 48px rgba(124,58,237,.24);
      animation: breathe 4.5s ease-in-out infinite;
      animation-play-state: paused; /* run only while timer is running */
    }
    .nap-circle.running{ animation-play-state: running; }
    @keyframes breathe{
      0%,100%{ box-shadow: 0 16px 48px rgba(124,58,237,.24) }
      50%{   box-shadow: 0 24px 64px rgba(167,139,250,.28) }
    }
    .nap-core{
      width: 76%; height: 76%; border-radius:50%;
      background: #fff; display:grid; place-items:center; text-align:center;
      padding: 1rem 1.25rem;
      box-shadow: inset 0 0 0 1px rgba(2,6,23,.06);
    }
    .countdown{
      font-size: clamp(2.2rem, 4.2vw, 3.2rem);
      font-weight: 900; letter-spacing: .5px; line-height:1;
    }
    .status{ color: var(--muted); font-size:.95rem; margin-top:.25rem; }

    .controls{ display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-top:.75rem; }
    .btn-violet{
      background: var(--violet); color:#fff; border:none; border-radius:9999px;
      padding: .6rem 1rem; font-weight:600;
    }
    .btn-violet:hover{ background: var(--violet-600); }
    .btn-ghost{
      background: #fff; border:1px solid var(--violet-300); color: var(--violet-600);
      border-radius:9999px; padding:.55rem .95rem; font-weight:600;
    }
    .btn-ghost:hover{ background:#f5f3ff; }

    /* Right panel */
    .panel{
      background: #ffffffc4;
      border:1px solid rgba(2,6,23,.06);
      border-radius: 18px; padding:18px;
    }
    .panel h5{ margin:0 0 .5rem 0; font-weight:800; color:#312e81; }

    .presets{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .chip{
      border-radius: 9999px; padding:.4rem .8rem; font-weight:700; cursor:pointer;
      background:#eef2ff; color:#4f46e5; border:1px solid #c7d2fe;
    }
    .chip:hover{ background:#e0e7ff; }
    .chip.active{ background:#c7d2fe; }

    .inline{
      display:flex; align-items:center; gap:.6rem; margin-top:.75rem;
    }
    .inline input{
      width: 5.5rem; text-align:center;
    }

    .quote{
      margin-top: .8rem; font-style: italic; color:#475569; font-size:.95rem;
      display:flex; gap:.5rem; align-items:flex-start;
    }

    /* --- Sleep Music mini player --- */
    .nap-mini {
      display:flex; gap:12px; align-items:center;
      border:1px solid rgba(2,6,23,.06); background:#ffffffc4;
      border-radius:12px; padding:12px;
    }
    .nap-mini img { width:56px; height:56px; object-fit:cover; border-radius:8px; background:#f3f3f3; }
    .nap-mini .meta { display:flex; flex-direction:column; min-width:0; }
    .nap-mini .title { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nap-mini .sub { color:#666; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .nap-mini .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .nap-mini .btn { padding:.45rem .8rem; border-radius:999px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .nap-mini .primary { background: var(--violet); color:#fff; border-color:transparent; text-decoration:none; }
    .nap-mini .status { color:#555; margin-top:4px; min-height:1.2em; }
  </style>
</head>

<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
<div class="app-wrapper">
  <!-- Header -->
  <nav class="app-header navbar navbar-expand bg-body">
    <div class="container-fluid">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
            <i class="bi bi-list"></i>
          </a>
        </li>
        <li class="nav-item d-none d-md-block"><a href="./nappingPage.html" class="nav-link active">Home</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="#" data-lte-toggle="fullscreen">
            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display:none"></i>
          </a>
        </li>
        <li class="nav-item dropdown user-menu">
          <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
            <img src="/dist/assets/img/user2-160x160.jpg" class="user-image rounded-circle shadow" alt="User Image"/>
            <span class="username-display d-none d-md-inline"></span>
          </a>
          <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
            <li class="user-header text-bg-primary">
              <img src="/dist/assets/img/user2-160x160.jpg" class="rounded-circle shadow" alt="User Image" />
              <p class="username-display"></p>
              <small>Member since Nov. 2023</small>
            </li>
            <li class="user-footer">
              <a href="#" class="btn btn-default btn-flat">Profile</a>
              <a id="logout-btn" href="#" class="btn btn-default btn-flat float-end">Sign out</a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Sidebar (same as Dashboard) -->
  <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
    <div class="sidebar-brand">
      <a href="./nappingPage.html" class="brand-link">
        <img src="/dist/assets/img/napsterlogo_image.png" class="brand-image opacity-75 shadow" alt="Logo" />
        <span class="brand-text fw-light">Napster</span>
      </a>
    </div>
    <div class="sidebar-wrapper">
      <nav class="mt-2">
        <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
          <li class="nav-item menu-open">
            <a href="./nappingPage.html" class="nav-link active"><i class="nav-icon bi bi-moon-stars"></i><p>Home</p></a>
          </li>
          <li class="nav-item"><a href="./dashboard.html" class="nav-link"><i class="nav-icon bi bi-speedometer"></i><p>Dashboard</p></a></li>
          <li class="nav-item"><a href="./napHistory.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>Nap History</p></a></li>
          <li class="nav-item"><a href="./napSchedule.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>Nap Schedule</p></a></li>
          <li class="nav-item"><a href="./location.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>Location Recommendation</p></a></li> 
          <li class="nav-item"><a href="./settings.html" class="nav-link"><i class="nav-icon bi bi-moon-stars"></i><p>Settings</p></a></li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Main -->
  <main class="app-main">
    <!-- ambient background blobs -->
    <div class="ambient" aria-hidden="true">
      <div class="blob violet"></div>
      <div class="blob sky"></div>
    </div>

    <div class="center-wrap">
      <div class="glass">
        <!-- LEFT: circle -->
        <section aria-label="Nap timer">
          <div class="nap-circle" id="napCircle">
            <div class="nap-core">
              <div id="countdown" class="countdown" aria-live="polite">20:00</div>
              <div id="status" class="status">Ready to nap</div>
              <div class="controls">
                <button id="startPauseBtn" class="btn-violet"><i class="bi bi-play-fill me-1"></i><span>Start</span></button>
                <button id="resetBtn" class="btn-ghost"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</button>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: presets + quote  -->
        <aside class="panel" aria-label="Nap options">
          <h5><i class="bi bi-stars me-2"></i>Quick presets</h5>
          <div class="presets" id="presets">
            <button class="chip active" data-min="15">15 min</button>
            <button class="chip" data-min="20">20 min</button>
            <button class="chip" data-min="30">30 min</button>
          </div>

          <div class="inline">
            <label for="durationMin" class="form-label m-0">Custom</label>
            <input id="durationMin" type="number" class="form-control form-control-sm" min="1" max="180" value="20" />
            <span>min</span>
          </div>

          <div class="quote">
            <i class="bi bi-quote"></i>
            <div id="quoteText">‚ÄúA short nap can refuel your day.‚Äù</div>
          </div>
        </aside>
        <!-- Kate Dinh adds for sleepMusic -->
        <!-- Sleep Music mini player (spans both columns) -->
        <section class="nap-mini" style="grid-column:1 / -1;" aria-label="Sleep music mini player">
          <img id="napMiniImg" alt="cover" />
          <div class="meta">
            <div class="title" id="napMiniTitle">No track selected</div>
            <div class="sub" id="napMiniSub">Rain ‚Äî 30s preview ‚Ä¢ Loop: On</div>
            <div class="status" id="napMiniStatus"></div>
          </div>
          <div class="actions">
            <button class="btn" id="napMiniPlay"><i class="bi bi-play-fill me-1"></i>Play</button>
            <button class="btn" id="napMiniPause"><i class="bi bi-pause-fill me-1"></i>Pause</button>
            <a class="btn primary" href="./sleepMusic.html?return=/nappingPage.html">
              <i class="bi bi-music-note-list me-1"></i>Change music
            </a>
          </div>
          <audio id="napMiniAudio" preload="auto"></audio>
        </section>
      </div>
    </div>

    <footer class="app-footer">
      <div class="float-end d-none d-sm-inline">Dream More. Do More.</div>
      <strong>Copyright &copy; 2025&nbsp;</strong> All rights reserved.
    </footer>
  </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
<script src="../../dist/js/adminlte.js"></script>

<script>
  // Sidebar scrollbars
  document.addEventListener('DOMContentLoaded', () => {
    const sidebarWrapper = document.querySelector('.sidebar-wrapper');
    if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
      OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
        scrollbars: { theme: 'os-theme-light', autoHide: 'leave', clickScroll: true }
      });
    }
  });

  // Auth display (safe if endpoint exists)
  fetch("/api/user")
    .then(res => { if (res.status === 401){ location.href = "/signin"; return null;} return res.json(); })
    .then(d => d?.username && document.querySelectorAll(".username-display").forEach(el => el.textContent = d.username))
    .catch(()=>{});
  document.getElementById("logout-btn")?.addEventListener("click", () => {
    fetch("/logout",{method:"POST"}).then(()=>location.href="/signin");
  });
</script>

<!-- Nap logic  -->
<script>
(function(){
  const circle = document.getElementById('napCircle');
  const countdownEl = document.getElementById('countdown');
  const statusEl = document.getElementById('status');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const durationInput = document.getElementById('durationMin');
  const presetsEl = document.getElementById('presets');

  const STATE = { IDLE:'idle', RUNNING:'running', PAUSED:'paused' };
  let state = STATE.IDLE;
  let durationSec = 0;
  let remainingSec = 0;
  let timerId = null;
  let startedAt = null;
  let currNapID = null;

  fetch("/api/naplen")
      .then(res => res.json())
      .then(data => {
        const naplen = data.preferrednaplen / 60; // if DB is in seconds
        durationSec = data.preferrednaplen;
        remainingSec = durationSec
        durationInput.value = naplen;
        countdownEl.textContent = fmt(data.preferrednaplen);
      });


  // Soft quotes
  const quotes = [
    "‚ÄúA short nap can refuel your day.‚Äù",
    "‚ÄúRest is part of the work.‚Äù",
    "‚ÄúClose eyes, open focus.‚Äù",
    "‚ÄúTwenty minutes to reset.‚Äù"
  ];
  document.getElementById('quoteText').textContent = quotes[Math.floor(Math.random()*quotes.length)];

  function fmt(sec){ const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return m+':'+s; }
  function setProgress(){ const pct = 100*(1-remainingSec/durationSec); circle.style.setProperty('--progress', pct+'%'); }
  function render(){ countdownEl.textContent = fmt(remainingSec); setProgress(); }

  function setState(next){
    state = next;
    if (state===STATE.IDLE){
      circle.classList.remove('running');
      statusEl.textContent = 'Ready to nap';
      startPauseBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Start';
    } else if (state===STATE.RUNNING){
      circle.classList.add('running');
      statusEl.textContent = 'Napping...';
      startPauseBtn.innerHTML = '<i class="bi bi-pause-fill me-1"></i>Pause';
    } else {
      circle.classList.remove('running');
      statusEl.textContent = 'Paused';
      startPauseBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Resume';
    }
  }

  async function start() {
    if (state===STATE.RUNNING) return;
    if (state===STATE.IDLE){
      durationSec = (Number(durationInput.value)||20)*60;
      remainingSec = durationSec;
      startedAt = new Date().toISOString();

      try {
          const res = await fetch("/api/startNap", {
            method: "POST",
          });

          if (!res.ok) {
            alert("‚ùå " + "failed to start nap");
            return;
          }

          if (res.ok) {
            const data = await res.json();   // <- parses { napID }
            currNapID = data.napID;

          } 
        } catch (err) {
          console.error(err);
        }

    }
    timerId = setInterval(tick, 1000);
    setState(STATE.RUNNING);
    render();
  }
  function pause(){ if (timerId){ clearInterval(timerId); timerId=null; } setState(STATE.PAUSED); }
  function reset(){
    if (timerId){ clearInterval(timerId); timerId=null; }
    durationSec = (Number(durationInput.value)||20)*60;
    remainingSec = durationSec; startedAt=null; setState(STATE.IDLE); render();
  }

  async function finish(){
    if (timerId){ clearInterval(timerId); timerId=null; }
    setState(STATE.IDLE);
    statusEl.textContent = 'Nap complete ‚ú®';

    const endedAt = new Date().toISOString();
    await saveNap({ startedAt, endedAt, durationSec });
    remainingSec = durationSec; render();
  }

  function tick(){
    if (remainingSec>0){ remainingSec--; render(); }
    else { finish(); }
  }

  // UI wiring
  startPauseBtn.addEventListener('click', () => (state===STATE.IDLE||state===STATE.PAUSED) ? start() : pause());
  resetBtn.addEventListener('click', reset);
  durationInput.addEventListener('change', () => {
    if (state===STATE.IDLE){
      durationSec=(Number(durationInput.value)||20)*60; remainingSec=durationSec; render();
      presetsEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    }
  });

  presetsEl.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    presetsEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    durationInput.value = chip.dataset.min;
    if (state===STATE.IDLE){ durationSec = Number(chip.dataset.min)*60; remainingSec = durationSec; render(); }
  });

  // Persistence (API first, fallback localStorage)
  async function saveNap(entry){
    try{
      const res = await fetch("/api/endNap", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ napID: currNapID })  // üëà send JSON
          });

          if (!res.ok) {
            alert("‚ùå " + "failed to end nap");
            return;
          }

          if (res.ok) {
            const data = await res.json();   // <- parses { napID }
            currNapID = data.napID;

          } 
    }catch{
      console.error(err);
          alert("‚ùå Something went wrong. Please try again.");
    }
  }

  // Init
  render();
})();
</script>

<!-- Sleep Music mini player logic -->
<script>
(() => {
  // Keys sleepMusic.html will write to
  const K = {
    preview: "nap.music.previewUrl",
    title: "nap.music.title",
    artist: "nap.music.artist",
    img: "nap.music.img",
    loop: "nap.settings.loop",
    fade: "nap.settings.fadeSec",
    auto: "nap.settings.autoStart",
  };

  const audio   = document.getElementById("napMiniAudio");
  const titleEl = document.getElementById("napMiniTitle");
  const subEl   = document.getElementById("napMiniSub");
  const imgEl   = document.getElementById("napMiniImg");
  const statusEl= document.getElementById("napMiniStatus");

  const getBool = (k, def) => {
    const v = localStorage.getItem(k);
    if (v === null) return !!def;
    return v === "true";
  };
  const getNum = (k, def) => {
    const n = Number(localStorage.getItem(k));
    return Number.isNaN(n) ? def : n;
  };

  function refreshFromStorage() {
    const src    = localStorage.getItem(K.preview) || "";
    const title  = localStorage.getItem(K.title) || "";
    const artist = localStorage.getItem(K.artist) || "";
    const img    = localStorage.getItem(K.img) || "";
    const loop   = getBool(K.loop, true);

    // Summary: ‚ÄúRain ‚Äî 30s preview ‚Ä¢ Loop: On‚Äù
    const summaryLeft  = title || "Rain";
    const summaryMid   = "30s preview";
    const summaryRight = `Loop: ${loop ? "On" : "Off"}`;

    audio.src  = src;
    audio.loop = loop;

    titleEl.textContent = title || "No track selected";
    subEl.textContent   = `${summaryLeft} ‚Äî ${summaryMid} ‚Ä¢ ${summaryRight}`;
    imgEl.src = img || "";
    imgEl.style.visibility = img ? "visible" : "hidden";
  }

  function setStatus(t){ statusEl.textContent = t; }

  // Controls
  document.getElementById("napMiniPlay").addEventListener("click", async () => {
    if (!audio.src) { setStatus("Choose music first (Change music)."); return; }
    audio.loop = getBool(K.loop, true);
    try { await audio.play(); setStatus("Playing"); }
    catch { setStatus("If autoplay is blocked, press Play in the player bar."); }
  });
  document.getElementById("napMiniPause").addEventListener("click", () => {
    audio.pause(); setStatus("Paused");
  });

  // Update on selection change from sleepMusic.html
  window.addEventListener("storage", (e) => {
    if ([K.preview, K.title, K.artist, K.img, K.loop].includes(e.key)) {
      refreshFromStorage();
      setStatus("Selection updated");
    }
  });

  // Initial load
  refreshFromStorage();
})();
</script>
</body>
</html>
